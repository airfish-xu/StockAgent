# LangGraph智能体协调架构

## 概述

本项目已将原有的子进程调用模式重构为基于LangGraph的统一智能体协调架构。新的架构使用状态图模式来协调数据收集、辩论、技术分析和决策四个智能体的工作流。

## 架构对比

### 传统架构（子进程调用模式）
- **实现方式**: 通过`subprocess.run()`依次调用各个智能体
- **数据传递**: 依赖文件系统读写
- **错误处理**: 简单的异常捕获
- **协作机制**: 缺乏真正的智能体间协作

### LangGraph架构（新一代）
- **实现方式**: 基于状态图的统一协调
- **数据传递**: 智能体间直接数据传递
- **错误处理**: 内置错误处理和重试机制
- **协作机制**: 支持复杂的条件路由和可视化工作流

## 核心组件

### 1. LangGraph协调器 (`langgraph_coordinator.py`)
- 定义智能体状态图
- 协调各个智能体节点的执行顺序
- 处理错误和条件路由

### 2. 数据模式 (`langgraph_schemas.py`)
- 定义LangGraph状态对象
- 标准化智能体间数据传递格式
- 提供类型安全的接口

### 3. 演示脚本 (`langgraph_demo.py`)
- 展示LangGraph架构的使用
- 提供架构对比和状态图可视化

## 使用方式

### 方法1: 通过主启动脚本
```bash
python run_master_agent.py
```
选择选项 `3` (LangGraph模式)

### 方法2: 直接使用协调器
```python
from master_agent.langgraph_coordinator import LangGraphCoordinator

coordinator = LangGraphCoordinator()
result = coordinator.analyze_investor("葛卫东")
```

### 方法3: 运行演示
```bash
python master_agent/langgraph_demo.py
```

## 状态图结构

```
START
  ↓
初始化节点 (initialize)
  ↓
数据收集节点 (collect_data)
  ↓
技术分析节点 (technical_analysis)
  ↓
辩论分析节点 (debate_analysis)  
  ↓
决策制定节点 (decision_making)
  ↓
最终化节点 (finalize)
  ↓
  END
```

**错误处理路径**: 任何节点 → 错误处理节点 (handle_error) → 最终化节点

## 智能体节点功能

### 1. 初始化节点
- 设置分析参数
- 准备分析环境
- 验证输入数据

### 2. 数据收集节点
- 获取投资人持仓数据
- 验证数据完整性
- 准备股票列表

### 3. 技术分析节点
- 分析股票技术指标
- 识别趋势和信号
- 评估风险水平

### 4. 辩论分析节点
- 进行多空观点辩论
- 汇总核心论点
- 识别分歧点

### 5. 决策制定节点
- 综合所有分析结果
- 应用投资规则
- 生成最终建议

### 6. 最终化节点
- 保存分析结果
- 生成报告
- 清理资源

## 优势特点

### 1. 统一协调
- 所有智能体在同一个状态图中运行
- 支持复杂的条件路由逻辑
- 内置错误处理和重试机制

### 2. 数据一致性
- 类型安全的数据传递
- 标准化的接口定义
- 实时状态跟踪

### 3. 可扩展性
- 易于添加新的智能体节点
- 支持并行执行优化
- 模块化的架构设计

### 4. 可视化
- 状态图可可视化展示
- 实时进度监控
- 详细的执行日志

## 依赖要求

```bash
# 安装LangGraph相关依赖
pip install langgraph>=0.0.40 langchain-core>=0.1.0 pydantic>=2.0.0

# 或使用提供的依赖文件
pip install -r master_agent/requirements_langgraph.txt
```

## 迁移指南

### 从传统模式迁移到LangGraph模式

1. **数据接口适配**
   - 将文件读写改为直接数据传递
   - 标准化输入输出格式

2. **错误处理升级**
   - 利用LangGraph的内置错误处理
   - 实现重试和回退机制

3. **性能优化**
   - 考虑并行执行可能
   - 优化数据传递效率

## 未来扩展

### 计划功能
- [ ] 支持智能体并行执行
- [ ] 添加实时进度监控界面
- [ ] 实现智能体热插拔机制
- [ ] 支持工作流版本管理

### 性能优化
- [ ] 缓存机制优化
- [ ] 异步执行支持
- [ ] 分布式部署支持

## 总结

LangGraph架构为多智能体系统提供了更加现代化和高效的协调机制。相比传统的子进程调用模式，新架构在协调性、错误处理、可扩展性等方面都有显著提升，为后续的功能扩展和性能优化奠定了坚实基础。

通过统一的状态图管理，系统能够更好地处理复杂的多智能体协作场景，为投资分析提供更加可靠和高效的技术支撑。